<!DOCTYPE html>
<html>
  <head>
    <title>Qubit Quarry</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" type="image/x-icon" href="/Data/Images/favicon.png" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
  </head>

  <body>
    <div class="container mt-3">
      <shop style="float: left; width: 30%; text-align: center; height: 100%">
        <h3>Upgrade Shop</h3>
        <ul class="list-group list-group-flush" id="upgradeShop"></ul>
      </shop>
      <div style="float: left; width: 40%">
        <button onclick="updatePoints(1)">
          <img
            id="cubeImage"
            src="/Data/Images/cubeStageOne.png"
            style="
              display: block;
              margin-left: auto;
              margin-right: auto;
              max-width: 100%;
            "
          />
        </button>
        <p id="pointDisplay" style="text-align: center"></p>
      </div>

      <inventory
        style="float: left; width: 30%; text-align: center; height: 100%"
      >
        <h3>Inventory</h3>
        <ul
        class="list-group list-group-flush"
          id="upgradeInventory"
        ></ul>
      </inventory>
      </div>
    </div>
    <script>
      const hostURL = "http://localhost:5000";

      var currentValues = {
        pointsTotal: 0,
        pointsSpent: 0,
        pointsGain: 0,
        pointsPassive: 0,
        lastClick: 0,
        canDestroyCube: false
      };

      const listItemClass = "list-group-item d-flex justify-content-between align-items-center";
      const listButtonClass = "btn btn-dark";

      function returnUser() {
        return new URLSearchParams(window.location.search).get("user");
      }

      function destroyCUBE(){
        //we have to fetch and delete the user's info!!!
        location.href = `../victory/`;
      }

      function updateMiningValues() {
        currentValues.pointsGain = 0;
        currentValues.pointsPassive = 0;

        let all_upgrades;
        let miningAddition = 0;
        let miningMultiply = 1;
        let miningExponent = 1;
        let miningPassive = 0;
        fetch(`${hostURL}/upgrades/`, { method: "GET" })
          .then((response) => response.json())
          .then((content) => {
            all_upgrades = content;
          })
          .then(()=>{
            fetch(`${hostURL}/users/${returnUser()}/upgrades/`, {
          method: "GET",
        })
          .then((response) => response.json())
          .then((content) => {
            for (let i = 0; i < all_upgrades.length; i++) {
              console.log(all_upgrades[i].internal_name)
              if (all_upgrades[i].internal_name === "pickaxe") {
                switch (content.pickaxe) {
                  case 1: {
                    miningAddition += all_upgrades[i].value_tier_1;
                    break;
                  }
                  case 2: {
                    miningAddition += all_upgrades[i].value_tier_2;
                    break;
                  }
                  case 3: {
                    miningAddition += all_upgrades[i].value_tier_3;
                    break;
                  }
                  case 4: {
                    miningAddition += all_upgrades[i].value_tier_4;
                    break;
                  }
                  case 5: {
                    miningAddition += all_upgrades[i].value_tier_5;
                    break;
                  }
                  default: {
                    miningAddition += 1;
                  }
                }
              } else if (all_upgrades[i].internal_name === "lantern") {
                if (content.lantern > 0) {
                  switch (content.lantern) {
                    case 1: {
                      miningMultiply *= all_upgrades[i].value_tier_1;
                      break;
                    }
                    case 2: {
                      miningMultiply *= all_upgrades[i].value_tier_2;
                      break;
                    }
                    case 3: {
                      miningMultiply *= all_upgrades[i].value_tier_3;
                      break;
                    }
                  }
                }
              } else if (all_upgrades[i].internal_name === "assistant") {
                if (content.assistant > 0) {
                  switch (content.assistant) {
                    case 1: {
                      miningPassive += all_upgrades[i].value_tier_1;
                      break;
                    }
                    case 2: {
                      miningPassive += all_upgrades[i].value_tier_2;
                      break;
                    }
                    case 3: {
                      miningPassive += all_upgrades[i].value_tier_3;
                      break;
                    }
                  }
                }
              } else if (all_upgrades[i].internal_name === "helmet") {
                if (content.helmet > 0) {
                  miningMultiply += all_upgrades[i].value_tier_1;
                }
              } else if (all_upgrades[i].internal_name === "housing") {
                if (content.housing > 0) {
                  miningExponent += all_upgrades[i].value_tier_1;
                }
              } else if (all_upgrades[i].internal_name === "meals") {
                if (content.meals > 0) {
                  miningExponent += all_upgrades[i].value_tier_1;
                }
              } else if (all_upgrades[i].internal_name === "cartographer") {
                if (content.cartographer > 0) {
                  miningMultiply *= all_upgrades[i].value_tier_1;
                }
              } else if(all_upgrades[i].internal_name === "winning_condition") {
                if (content.winning_condition){
                  currentValues.canDestroyCube = true;
                }
              } 
              else {
                console.log(`Invalid upgrade ${all_upgrades[i].internal_name}`);
              }
            }
            currentValues.pointsPassive = miningPassive;
            currentValues.pointsGain +=
              miningAddition ** miningExponent * miningMultiply;
            console.log(
              `Current User Values: ${JSON.stringify(currentValues)}`
            );
          });});

        
      }

      function updatePoints(variation) {
        const userID = returnUser();
        let timeSpent;
        
        if (currentValues.canDestroyCube){
          destroyCUBE()
        } 
        else {

        fetch(`${hostURL}/users/${userID}`, { method: "GET" })
          .then((response) => response.json())
          .then((content) => {
            currentValues.pointsTotal = content.total_points;
            currentValues.pointsSpent = content.spent_points;
            currentValues.lastClick = content.last_click;
            timeSpent = Math.floor(Date.now() / 1000) - currentValues.lastClick;
          })
          .then(() => {
            fetch(`${hostURL}/users/${userID}/`, {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                total_points:
                  currentValues.pointsTotal +
                  currentValues.pointsGain * variation +
                  currentValues.pointsPassive * timeSpent,
                last_click: Math.floor(Date.now() / 1000),
              }),
            })
              .then(() => {
                currentValues.pointsTotal +=
                  currentValues.pointsGain * variation +
                  currentValues.pointsPassive * timeSpent;
                updatePointDisplay();
              })
              .catch((error) => {
                console.log("Request failed", error);
              });
          });}
      }

      function updatePointDisplay() {
        const pointDisplay = document.getElementById("pointDisplay");
        pointDisplay.innerText = `Qubit Fragments:
        ${Math.floor(currentValues.pointsTotal - currentValues.pointsSpent)}`;
      }

      function addToList(name, list, internal_name, tier, cost, description) {
        const listItem = document.createElement("li");
        listItem.innerText = name;
        listItem.className = listItemClass;
        if (list === "inventory") {
          const inventory = document.getElementById("upgradeInventory");
          inventory.appendChild(listItem);
        } else if (list === "shop") {
          const shop = document.getElementById("upgradeShop");
          const itemButton = document.createElement("button");
          itemButton.innerText = `Buy - ${cost} Qubit Shards`;
          itemButton.addEventListener("click", () => {
            buyUpgrade(internal_name, tier, cost);
          })
          itemButton.className = listButtonClass;
          listItem.appendChild(itemButton);
          shop.appendChild(listItem);
        }
      }

      function buyUpgrade(internalName, tier, cost) {
        const userID = returnUser();
        
        if (internalName === 'winning_condition'){
          alert("You have obtained Anti-CUBE weaponry. You can now destroy THE CUBE.")
        }

        fetch(`${hostURL}/users/${userID}/`, { method: "GET" })
          .then((response) => response.json())
          .then((content) => {
            currentValues.pointsTotal = content.total_points;
            currentValues.pointsSpent = content.spent_points || 0;
            console.log(`Spent: ${currentValues.pointsSpent}. Total: ${currentValues.pointsTotal}`)
      
            console.log(`User Total Points: ${currentValues.pointsTotal}`);
            console.log(`User Spent Points: ${currentValues.pointsSpent}`);
      
            const availablePoints = currentValues.pointsTotal - currentValues.pointsSpent;
      
            console.log(`Available Points: ${availablePoints}`);
            console.log(`Cost of Upgrade: ${cost}`);
      
            if (availablePoints >= cost) {
              const newSpentPoints = currentValues.pointsSpent + cost;
              console.log("Attempting to spend points")
              fetch(`${hostURL}/users/${userID}/`, {
                method: "PUT",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({
                  spent_points: newSpentPoints,
                }),
              })
                .then(() => {
                  console.log("Attempting to update upgrade")
                  fetch(`${hostURL}/users/${userID}/upgrades/`, {
                    method: "PUT",
                    headers: {
                      "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                      [internalName]: tier,
                    }),
                  })
                    .then(() => {
                      //alert(`${internalName}, tier ${tier} was bought for ${cost} qubit fragments.`);
                      updatePoints(0);
                      updateInventory();
                      updateMiningValues();
                      updatePointDisplay();
                      //winning(); //llamo a winning() para verificar si el usuario tiene todas las mejoras
                    })
                    .catch((error) => {
                      console.error("Failed to update user upgrade", error);
                      alert("An error occurred while updating your upgrade.");
                    });
                })
                .catch((error) => {
                  console.error("Failed to update user points", error);
                  alert("An error occurred while updating your points.");
                });
            } else {
              alert(`${internalName}, tier ${tier} couldn't be bought. Insufficient fragments.`);
            }
          })
          .catch((error) => {
            console.error("Failed to fetch user data.", error);
            alert("An error occurred while fetching user data.");
          });
      }

      function updateInventory() {
        const upgradeShop = document.getElementById("upgradeShop");
        const upgradeInventory = document.getElementById("upgradeInventory");

        let all_upgrades;

        fetch(`${hostURL}/upgrades/`, { method: "GET" })
          .then((response) => response.json())
          .then((content) => {
            all_upgrades = content;
          })
          .then(
            fetch(`${hostURL}/users/${returnUser()}/upgrades`, {
              method: "GET",
            })
              .then((response) => response.json())
              .then((content) => {
                upgradeShop.innerHTML = "";
                upgradeInventory.innerHTML = "";
                for (let i = 0; i < all_upgrades.length; i++) {
                  console.log(`${JSON.stringify(all_upgrades)}`)
                  if (all_upgrades[i].internal_name === "pickaxe") {
                    switch (content.pickaxe) {
                      case 0: {
                        addToList(
                          all_upgrades[i].name_tier_1,
                          "shop",
                          all_upgrades[i].internal_name,
                          1,
                          all_upgrades[i].cost_tier_1
                        );
                        addToList("Bare Fists", "inventory");
                        break;
                      }
                      case 1: {
                        addToList(
                          all_upgrades[i].name_tier_2,
                          "shop",
                          all_upgrades[i].internal_name,
                          2,
                          all_upgrades[i].cost_tier_2
                        );
                        addToList(all_upgrades[i].name_tier_1, "inventory");
                        break;
                      }
                      case 2: {
                        addToList(
                          all_upgrades[i].name_tier_3,
                          "shop",
                          all_upgrades[i].internal_name,
                          3,
                          all_upgrades[i].cost_tier_3
                        );
                        addToList(all_upgrades[i].name_tier_2, "inventory");
                        break;
                      }
                      case 3: {
                        addToList(
                          all_upgrades[i].name_tier_4,
                          "shop",
                          all_upgrades[i].internal_name,
                          4,
                          all_upgrades[i].cost_tier_4
                        );
                        addToList(all_upgrades[i].name_tier_3, "inventory");
                        break;
                      }
                      case 4: {
                        addToList(
                          all_upgrades[i].name_tier_5,
                          "shop",
                          all_upgrades[i].internal_name,
                          5,
                          all_upgrades[i].cost_tier_5
                        );
                        addToList(all_upgrades[i].name_tier_4, "inventory");
                        break;
                      }
                      case 5: {
                        addToList(all_upgrades[i].name_tier_5, "inventory");
                        break;
                      }
                    }
                  } else if (all_upgrades[i].internal_name === "lantern") {
                    switch (content.lantern) {
                      case 0: {
                        addToList(
                          all_upgrades[i].name_tier_1,
                          "shop",
                          all_upgrades[i].internal_name,
                          1,
                          all_upgrades[i].cost_tier_1
                        );
                        break;
                      }
                      case 1: {
                        addToList(
                          all_upgrades[i].name_tier_2,
                          "shop",
                          all_upgrades[i].internal_name,
                          2,
                          all_upgrades[i].cost_tier_2
                        );
                        addToList(all_upgrades[i].name_tier_1, "inventory");
                        break;
                      }
                      case 2: {
                        addToList(
                          all_upgrades[i].name_tier_3,
                          "shop",
                          all_upgrades[i].internal_name,
                          3,
                          all_upgrades[i].cost_tier_3
                        );
                        addToList(all_upgrades[i].name_tier_2, "inventory");
                        break;
                      }
                      case 3: {
                        addToList(all_upgrades[i].name_tier_3, "inventory");
                        break;
                      }
                    }
                  } else if (all_upgrades[i].internal_name === "assistant") {
                    switch (content.assistant) {
                      case 0: {
                        addToList(
                          all_upgrades[i].name_tier_1,
                          "shop",
                          all_upgrades[i].internal_name,
                          1,
                          all_upgrades[i].cost_tier_1
                        );
                        break;
                      }
                      case 1: {
                        addToList(
                          all_upgrades[i].name_tier_2,
                          "shop",
                          all_upgrades[i].internal_name,
                          2,
                          all_upgrades[i].cost_tier_2
                        );
                        addToList(all_upgrades[i].name_tier_1, "inventory");
                        break;
                      }
                      case 2: {
                        addToList(
                          all_upgrades[i].name_tier_3,
                          "shop",
                          all_upgrades[i].internal_name,
                          3,
                          all_upgrades[i].cost_tier_3
                        );
                        addToList(all_upgrades[i].name_tier_2, "inventory");
                        break;
                      }
                      case 3: {
                        addToList(all_upgrades[i].name_tier_3, "inventory");
                        break;
                      }
                    }
                  } else if (all_upgrades[i].internal_name === "helmet") {
                    switch (content.helmet) {
                      case 0: {
                        addToList(
                          all_upgrades[i].name_tier_1,
                          "shop",
                          all_upgrades[i].internal_name,
                          1,
                          all_upgrades[i].cost_tier_1
                        );
                        break;
                      }
                      case 1: {
                        addToList(all_upgrades[i].name_tier_1, "inventory");
                        break;
                      }
                    }
                  } else if (all_upgrades[i].internal_name === "housing") {
                    switch (content.housing) {
                      case 0: {
                        addToList(
                          all_upgrades[i].name_tier_1,
                          "shop",
                          all_upgrades[i].internal_name,
                          1,
                          all_upgrades[i].cost_tier_1
                        );
                        break;
                      }
                      case 1: {
                        addToList(all_upgrades[i].name_tier_1, "inventory");
                        break;
                      }
                    }
                  } else if (all_upgrades[i].internal_name === "meals") {
                    switch (content.meals) {
                      case 0: {
                        addToList(
                          all_upgrades[i].name_tier_1,
                          "shop",
                          all_upgrades[i].internal_name,
                          1,
                          all_upgrades[i].cost_tier_1
                        );
                        break;
                      }
                      case 1: {
                        addToList(all_upgrades[i].name_tier_1, "inventory");
                        break;
                      }
                    }
                  } else if (all_upgrades[i].internal_name === "cartographer") {
                    switch (content.cartographer) {
                      case 0: {
                        addToList(
                          all_upgrades[i].name_tier_1,
                          "shop",
                          all_upgrades[i].internal_name,
                          1,
                          all_upgrades[i].cost_tier_1
                        );
                        break;
                      }
                      case 1: {
                        addToList(all_upgrades[i].name_tier_1, "inventory");
                        break;
                      }
                    }
                    
                  } else if (all_upgrades[i].internal_name === "winning_condition"){
                    if (content.pickaxe === 5 && content.lantern === 3 && content.assistant === 3 && content.helmet === 1 && content.housing === 1 && content.meals === 1 && content.cartographer === 1){
                      if (content.winning_condition === 0){
                        addToList(all_upgrades[i].name_tier_1, "shop", all_upgrades[i].internal_name, 1, all_upgrades[i].cost_tier_1)
                      } else {
                        addToList(all_upgrades[i].name_tier_1, "inventory")
                      }
                    }
                  }
                }
              })
          );
      }
      
      updatePoints(0);
      updateMiningValues();
      updatePointDisplay();
      updateInventory();
    </script>
  </body>
</html>
