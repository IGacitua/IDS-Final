<!DOCTYPE html>
<html>
  <head>
    <title>Qubit Quarry</title>
    <link rel="icon" type="image/x-icon" href="/Data/Images/favicon.png" />
  </head>

  <body>
    <div>
      <shop style="float: left; width: 30%; text-align: center; height: 100%">
        <h3>Upgrade Shop</h3>
        <ul style="list-style-type: none" id="upgradeShop"></ul>
      </shop>
      <div style="float: left; width: 40%">
        <button onclick="updatePoints(1)">
          <img
            id="cubeImage"
            src="/Data/Images/cubeStageOne.png"
            style="
              display: block;
              margin-left: auto;
              margin-right: auto;
              max-width: 100%;
            "
          />
        </button>
        <p id="pointDisplay" style="text-align: center"></p>
      </div>

      <inventory
        style="float: left; width: 30%; text-align: center; height: 100%"
      >
        <h3>Inventory</h3>
        <ul
          style="list-style-type: none; height: 100%"
          id="upgradeInventory"
        ></ul>
      </inventory>
    </div>
    <script>
      const hostURL = "http://localhost:5000";

      var currentValues = {
        pointsTotal: 0,
        pointsSpent: 0,
        pointsGain: 0,
        pointsPassive: 0,
        lastClick: 0,
      };

      function returnUser() {
        return new URLSearchParams(window.location.search).get("user");
      }

      function updateMiningValues() {
        currentValues.pointsGain = 0;
        currentValues.pointsPassive = 0;

        let all_upgrades;

        fetch(`${hostURL}/upgrades/`, { method: "GET" })
          .then((response) => response.json())
          .then((content) => {
            all_upgrades = content;
          });

        let miningAddition = 0;
        let miningMultiply = 1;
        let miningExponent = 1;
        let miningPassive = 0;

        fetch(`${hostURL}/users/${returnUser()}/upgrades/`, {
          method: "GET",
        })
          .then((response) => response.json())
          .then((content) => {
            for (let i = 0; i < all_upgrades.length; i++) {
              if (all_upgrades[i].internal_name === "pickaxe") {
                console.log(`Pickaxe Value: ${content.pickaxe}`);
                switch (content.pickaxe) {
                  case 1: {
                    miningAddition += all_upgrades[i].value_tier_1;
                    break;
                  }
                  case 2: {
                    miningAddition += all_upgrades[i].value_tier_2;
                    break;
                  }
                  case 3: {
                    miningAddition += all_upgrades[i].value_tier_3;
                    break;
                  }
                  case 4: {
                    miningAddition += all_upgrades[i].value_tier_4;
                    break;
                  }
                  case 5: {
                    miningAddition += all_upgrades[i].value_tier_5;
                    break;
                  }
                  default: {
                    miningAddition += 1;
                  }
                }
              } else if (all_upgrades[i].internal_name === "lantern") {
                if (content.lantern > 0) {
                  console.log(`Lantern value: ${content.lantern}`);
                  switch (content.lantern) {
                    case 1: {
                      miningMultiply *= all_upgrades[i].value_tier_1;
                      break;
                    }
                    case 2: {
                      miningMultiply *= all_upgrades[i].value_tier_2;
                      break;
                    }
                    case 3: {
                      miningMultiply *= all_upgrades[i].value_tier_3;
                      break;
                    }
                  }
                }
              } else if (all_upgrades[i].internal_name === "assistant") {
                if (content.assistant > 0) {
                  console.log(`Assistant Value: ${content.assitant}`);
                  switch (content.assistant) {
                    case 1: {
                      miningPassive += all_upgrades[i].value_tier_1;
                      break;
                    }
                    case 2: {
                      miningPassive += all_upgrades[i].value_tier_2;
                      break;
                    }
                    case 3: {
                      miningPassive += all_upgrades[i].value_tier_3;
                      break;
                    }
                  }
                }
              } else if (all_upgrades[i].internal_name === "helmet") {
                if (content.helmet > 0) {
                  console.log(`Helmet Value: ${content.helmet}`);
                  miningMultiply += all_upgrades[i].value_tier_1;
                  break;
                }
              } else if (all_upgrades[i].internal_name === "housing") {
                if (content.housing > 0) {
                  console.log(`Housing Value: ${content.housing}`);
                  miningExponent += all_upgrades[i].value_tier_1;
                }
              } else if (all_upgrades[i].internal_name === "meals") {
                if (content.meals > 0) {
                  console.log(`Meals Value: ${content.meals}`);
                  miningExponent += all_upgrades[i].value_tier_1;
                }
              } else if (all_upgrades[i].internal_name === "cartographer") {
                if (content.cartographer > 0) {
                  console.log(`Cartographer Value: ${content.cartographer}`);
                  miningMultiply *= all_upgrades[i].value_tier_1;
                }
              } else {
                console.log(`Invalid upgrade ${all_upgrades[i].internal_name}`);
              }
            }
            currentValues.pointsPassive = miningPassive;
            currentValues.pointsGain +=
              miningAddition ** miningExponent * miningMultiply;
            console.log(
              `Current User Values: ${JSON.stringify(currentValues)}`
            );
          });
      }

      function updatePoints(variation) {
        const userID = returnUser();
        let timeSpent;

        fetch(`${hostURL}/users/${userID}`, { method: "GET" })
          .then((response) => response.json())
          .then((content) => {
            currentValues.pointsTotal = content.total_points;
            currentValues.lastClick = content.last_click;
            timeSpent = Math.floor(Date.now() / 1000) - currentValues.lastClick;
          })
          .then(() => {
            fetch(`${hostURL}/users/${userID}/`, {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                total_points:
                  currentValues.pointsTotal +
                  currentValues.pointsGain * variation +
                  currentValues.pointsPassive * timeSpent,
                last_click: Math.floor(Date.now() / 1000),
              }),
            })
              .then(() => {
                currentValues.pointsTotal +=
                  currentValues.pointsGain * variation +
                  currentValues.pointsPassive * timeSpent;
                updatePointDisplay();
              })
              .catch((error) => {
                console.log("Request failed", error);
              });
          });
      }

      function updatePointDisplay() {
        const pointDisplay = document.getElementById("pointDisplay");
        pointDisplay.innerText = `Qubit Fragments:
        ${Math.floor(currentValues.pointsTotal - currentValues.pointsSpent)}`;
      }

      function buyUpgrade(internalName, tier, cost) {
        alert(
          `${internalName}, tier ${tier} was bought for ${cost} qubit fragments.`
        );
        updateInventory();
        updateMiningValues();
        updateUpgrades(); // After EVERYTHING executes, update upgrade lists and mining values
      }

      function addToList(name, list, internal_name, tier, cost) {
        const listItem = document.createElement("li");
        listItem.innerText = name;
        if (list === "inventory") {
          const inventory = document.getElementById("upgradeInventory");
          inventory.appendChild(listItem);
        } else if (list === "shop") {
          const shop = document.getElementById("upgradeShop");
          const itemButton = document.createElement("button");
          itemButton.innerText = `Buy - ${cost} Qubit Shards`;
          itemButton.addEventListener("click", () => {
            buyUpgrade(internal_name, tier, cost);
          });
          listItem.appendChild(itemButton);
          shop.appendChild(listItem);
        }
      }

      function updateInventory() {
        const upgradeShop = document.getElementById("upgradeShop");
        const upgradeInventory = document.getElementById("upgradeInventory");

        let all_upgrades;

        fetch(`${hostURL}/upgrades/`, { method: "GET" })
          .then((response) => response.json())
          .then((content) => {
            all_upgrades = content;
          })
          .then(
            fetch(`${hostURL}/users/${returnUser()}/upgrades`, {
              method: "GET",
            })
              .then((response) => response.json())
              .then((content) => {
                upgradeShop.innerHTML = "";
                upgradeInventory.innerHTML = "";
                for (let i = 0; i < all_upgrades.length; i++) {
                  if (all_upgrades[i].internal_name === "pickaxe") {
                    switch (content.pickaxe) {
                      case 0: {
                        addToList(
                          all_upgrades[i].name_tier_1,
                          "shop",
                          all_upgrades[i].internal_name,
                          1,
                          all_upgrades[i].cost_tier_1
                        );
                        addToList("Bare Fists", "inventory");
                        break;
                      }
                      case 1: {
                        addToList(
                          all_upgrades[i].name_tier_2,
                          "shop",
                          all_upgrades[i].internal_name,
                          2,
                          all_upgrades[i].cost_tier_2
                        );
                        addToList(all_upgrades[i].name_tier_1, "inventory");
                        break;
                      }
                      case 2: {
                        addToList(
                          all_upgrades[i].name_tier_3,
                          "shop",
                          all_upgrades[i].internal_name,
                          3,
                          all_upgrades[i].cost_tier_3
                        );
                        addToList(all_upgrades[i].name_tier_2, "inventory");
                        break;
                      }
                      case 3: {
                        addToList(
                          all_upgrades[i].name_tier_4,
                          "shop",
                          all_upgrades[i].internal_name,
                          4,
                          all_upgrades[i].cost_tier_4
                        );
                        addToList(all_upgrades[i].name_tier_3, "inventory");
                        break;
                      }
                      case 4: {
                        addToList(
                          all_upgrades[i].name_tier_5,
                          "shop",
                          all_upgrades[i].internal_name,
                          5,
                          all_upgrades[i].cost_tier_5
                        );
                        addToList(all_upgrades[i].name_tier_4, "inventory");
                        break;
                      }
                      case 5: {
                        addToList(all_upgrades[i].name_tier_5, "inventory");
                        break;
                      }
                    }
                  } else if (all_upgrades[i].internal_name === "lantern") {
                    switch (content.lantern) {
                      case 0: {
                        addToList(
                          all_upgrades[i].name_tier_1,
                          "shop",
                          all_upgrades[i].internal_name,
                          1,
                          all_upgrades[i].cost_tier_1
                        );
                        break;
                      }
                      case 1: {
                        addToList(
                          all_upgrades[i].name_tier_2,
                          "shop",
                          all_upgrades[i].internal_name,
                          2,
                          all_upgrades[i].cost_tier_2
                        );
                        addToList(all_upgrades[i].name_tier_1, "inventory");
                        break;
                      }
                      case 2: {
                        addToList(
                          all_upgrades[i].name_tier_3,
                          "shop",
                          all_upgrades[i].internal_name,
                          3,
                          all_upgrades[i].cost_tier_3
                        );
                        addToList(all_upgrades[i].name_tier_2, "inventory");
                        break;
                      }
                      case 3: {
                        addToList(all_upgrades[i].name_tier_3, "inventory");
                        break;
                      }
                    }
                  } else if (all_upgrades[i].internal_name === "assistant") {
                    switch (content.assistant) {
                      case 0: {
                        addToList(
                          all_upgrades[i].name_tier_1,
                          "shop",
                          all_upgrades[i].internal_name,
                          1,
                          all_upgrades[i].cost_tier_1
                        );
                        break;
                      }
                      case 1: {
                        addToList(
                          all_upgrades[i].name_tier_2,
                          "shop",
                          all_upgrades[i].internal_name,
                          2,
                          all_upgrades[i].cost_tier_2
                        );
                        addToList(all_upgrades[i].name_tier_1, "inventory");
                        break;
                      }
                      case 2: {
                        addToList(
                          all_upgrades[i].name_tier_3,
                          "shop",
                          all_upgrades[i].internal_name,
                          3,
                          all_upgrades[i].cost_tier_3
                        );
                        addToList(all_upgrades[i].name_tier_2, "inventory");
                        break;
                      }
                      case 3: {
                        addToList(all_upgrades[i].name_tier_3, "inventory");
                        break;
                      }
                    }
                  } else if (all_upgrades[i].internal_name === "helmet") {
                    switch (content.helmet) {
                      case 0: {
                        addToList(
                          all_upgrades[i].name_tier_1,
                          "shop",
                          all_upgrades[i].internal_name,
                          1,
                          all_upgrades[i].cost_tier_1
                        );
                        break;
                      }
                      case 1: {
                        addToList(
                          all_upgrades[i].name_tier_2,
                          "shop",
                          all_upgrades[i].internal_name,
                          2,
                          all_upgrades[i].cost_tier_2
                        );
                        addToList(all_upgrades[i].name_tier_1, "inventory");
                        break;
                      }
                    }
                  } else if (all_upgrades[i].internal_name === "housing") {
                    switch (content.housing) {
                      case 0: {
                        addToList(
                          all_upgrades[i].name_tier_1,
                          "shop",
                          all_upgrades[i].internal_name,
                          1,
                          all_upgrades[i].cost_tier_1
                        );
                        break;
                      }
                      case 1: {
                        addToList(
                          all_upgrades[i].name_tier_2,
                          "shop",
                          all_upgrades[i].internal_name,
                          2,
                          all_upgrades[i].cost_tier_2
                        );
                        addToList(all_upgrades[i].name_tier_1, "inventory");
                        break;
                      }
                    }
                  } else if (all_upgrades[i].internal_name === "meals") {
                    switch (content.meals) {
                      case 0: {
                        addToList(
                          all_upgrades[i].name_tier_1,
                          "shop",
                          all_upgrades[i].internal_name,
                          1,
                          all_upgrades[i].cost_tier_1
                        );
                        break;
                      }
                      case 1: {
                        addToList(
                          all_upgrades[i].name_tier_2,
                          "shop",
                          all_upgrades[i].internal_name,
                          2,
                          all_upgrades[i].cost_tier_2
                        );
                        addToList(all_upgrades[i].name_tier_1, "inventory");
                        break;
                      }
                    }
                  } else if (all_upgrades[i].internal_name === "cartographer") {
                    switch (content.cartographer) {
                      case 0: {
                        addToList(
                          all_upgrades[i].name_tier_1,
                          "shop",
                          all_upgrades[i].internal_name,
                          1,
                          all_upgrades[i].cost_tier_1
                        );
                        break;
                      }
                      case 1: {
                        addToList(
                          all_upgrades[i].name_tier_2,
                          "shop",
                          all_upgrades[i].internal_name,
                          2,
                          all_upgrades[i].cost_tier_2
                        );
                        addToList(all_upgrades[i].name_tier_1, "inventory");
                        break;
                      }
                    }
                  }
                }
              })
          );
      }
      updatePoints(0);
      updateMiningValues();
      updatePointDisplay();
      updateInventory();
    </script>
  </body>
</html>
