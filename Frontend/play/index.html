<!DOCTYPE html>
<html>
  <head>
    <title>Qubit Quarry</title>
    <link rel="icon" type="image/x-icon" href="/Data/Images/favicon.png" />
  </head>

  <body>
    <div>
      <shop style="float: left; width: 30%; text-align: center; height: 100%">
        <h3>Upgrade Shop</h3>
        <ul style="list-style-type: none" id="upgradeShop"></ul>
      </shop>
      <div style="float: left; width: 40%">
        <button onclick="updatePoints(1)">
          <img
            id="cubeImage"
            src="/Data/Images/cubeStageOne.png"
            style="
              display: block;
              margin-left: auto;
              margin-right: auto;
              max-width: 100%;
            "
          />
        </button>
        <p id="pointDisplay" style="text-align: center"></p>
      </div>

      <inventory
        style="float: left; width: 30%; text-align: center; height: 100%"
      >
        <h3>Inventory</h3>
        <ul
          style="list-style-type: none; height: 100%"
          id="upgradeInventory"
        ></ul>
      </inventory>
    </div>
    <script>
      var currentValues = {
        pointsTotal: 0,
        pointsSpent: 0,
        pointsGain: 1,
        pointsPassive: 0,
        lastClick: 0,
      };

      function returnUser() {
        return new URLSearchParams(window.location.search).get("user");
      }

      function fetchUserUpgrades() {
        currentValues.pointsGain = 1;
        currentValues.pointsPassive = 0;

        let all_upgrades;

        fetch(`http://localhost:5000/upgrades/`, { method: "GET" })
          .then((response) => response.json())
          .then((content) => {
            all_upgrades = content;
          });

        let miningAddition = 0;
        let miningMultiply = 1;
        let miningExponent = 1;
        let miningPassive = 0;

        fetch(`http://localhost:5000/users/${returnUser()}/upgrades/`, {
          method: "GET",
        })
          .then((response) => response.json())
          .then((content) => {
            for (let i = 0; i < all_upgrades.length; i++) {
              if (all_upgrades[i].internal_name === "pickaxe") {
                if (content.pickaxe > 0) {
                  console.log(`Pickaxe value: ${content.pickaxe}`);
                  switch (content.pickaxe) {
                    case 1: {
                      console.log(`Added ${all_upgrades[i].value_tier_1}`);
                      miningAddition += all_upgrades[i].value_tier_1;
                      break;
                    }
                    case 2: {
                      console.log(`Added ${all_upgrades[i].value_tier_2}`);
                      miningAddition += all_upgrades[i].value_tier_2;
                      break;
                    }
                    case 3: {
                      console.log(`Added ${all_upgrades[i].value_tier_3}`);
                      miningAddition += all_upgrades[i].value_tier_3;
                      break;
                    }
                    case 4: {
                      console.log(`Added ${all_upgrades[i].value_tier_4}`);
                      miningAddition += all_upgrades[i].value_tier_4;
                      break;
                    }
                    case 5: {
                      console.log(`Added ${all_upgrades[i].value_tier_5}`);
                      miningAddition += all_upgrades[i].value_tier_5;
                      break;
                    }
                  }
                }
              } else if (all_upgrades[i].internal_name === "lantern") {
                if (content.lantern > 0) {
                  console.log(`Lantern value: ${content.lantern}`);
                  switch (content.lantern) {
                    case 1: {
                      miningMultiply *= all_upgrades[i].value_tier_1;
                      break;
                    }
                    case 2: {
                      miningMultiply *= all_upgrades[i].value_tier_2;
                      break;
                    }
                    case 3: {
                      miningMultiply *= all_upgrades[i].value_tier_3;
                      break;
                    }
                  }
                }
              } else if (all_upgrades[i].internal_name === "assistant") {
                if (content.assistant > 0) {
                  console.log(`Assistant Value: ${content.assitant}`);
                  switch (content.assistant) {
                    case 1: {
                      miningPassive += all_upgrades[i].value_tier_1;
                      break;
                    }
                    case 2: {
                      miningPassive += all_upgrades[i].value_tier_2;
                      break;
                    }
                    case 3: {
                      miningPassive += all_upgrades[i].value_tier_3;
                      break;
                    }
                  }
                }
              } else if (all_upgrades[i].internal_name === "helmet") {
                if (content.helmet > 0) {
                  console.log(`Helmet Value: ${content.helmet}`);
                  miningMultiply += all_upgrades[i].value_tier_1;
                  break;
                }
              } else if (all_upgrades[i].internal_name === "housing") {
                if (content.housing > 0) {
                  console.log(`Housing Value: ${content.housing}`);
                  miningExponent += all_upgrades[i].value_tier_1;
                }
              } else if (all_upgrades[i].internal_name === "meals") {
                if (content.meals > 0) {
                  console.log(`Meals Value: ${content.meals}`);
                  miningExponent += all_upgrades[i].value_tier_1;
                }
              } else if (all_upgrades[i].internal_name === "cartographer") {
                if (content.cartographer > 0) {
                  console.log(`Cartographer Value: ${content.cartographer}`);
                  miningMultiply *= all_upgrades[i].value_tier_1;
                }
              } else {
                console.log(`Invalid upgrade ${all_upgrades[i].internal_name}`);
              }
            }
            currentValues.pointsPassive = miningPassive;
            currentValues.pointsGain =
              miningAddition ** miningExponent * miningMultiply;
            console.log(
              `Current User Values: ${JSON.stringify(currentValues)}`
            );
          });
      }

      function updatePoints(variation) {
        const userID = returnUser();
        let timeSpent;

        fetch(`http://localhost:5000/users/${userID}`, { method: "GET" })
          .then((response) => response.json())
          .then((content) => {
            currentValues.pointsTotal = content.total_points;
            currentValues.lastClick = content.last_click;
            timeSpent = Math.floor(Date.now() / 1000) - currentValues.lastClick;
          })
          .then(() => {
            fetch(`http://localhost:5000/users/${userID}/`, {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                total_points:
                  currentValues.pointsTotal +
                  currentValues.pointsGain * variation +
                  currentValues.pointsPassive * timeSpent,
                last_click: Math.floor(Date.now() / 1000),
              }),
            })
              .then(() => {
                currentValues.pointsTotal +=
                  currentValues.pointsGain * variation +
                  currentValues.pointsPassive * timeSpent;
                updatePointDisplay();
              })
              .catch((error) => {
                console.log("Request failed", error);
              });
          });
      }

      function updatePointDisplay() {
        const pointDisplay = document.getElementById("pointDisplay");
        pointDisplay.innerText = `Current Points:
        ${Math.floor(currentValues.pointsTotal - currentValues.pointsSpent)}`;
      }

      updatePoints(0);
      fetchUserUpgrades();
      updatePointDisplay();
    </script>
  </body>
</html>
