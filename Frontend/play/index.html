<!DOCTYPE html>
<html>
  <head>
    <title>Qubit Quarry</title>
    <link rel="icon" type="image/x-icon" href="/Data/Images/favicon.png" />
  </head>

  <body>
    <div>
      <shop style="float: left; width: 30%; text-align: center; height: 100%">
        <h3>Upgrade Shop</h3>
        <ul style="list-style-type: none" id="upgradeShop"></ul>
      </shop>
      <div style="float: left; width: 40%">
        <button onclick="calculatePoints()">
          <img
            id="cubeImage"
            src="/Data/Images/cubeStageOne.png"
            style="
              display: block;
              margin-left: auto;
              margin-right: auto;
              max-width: 100%;
            "
          />
        </button>
        <p id="pointDisplay" style="text-align: center"></p>
      </div>

      <inventory
        style="float: left; width: 30%; text-align: center; height: 100%"
      >
        <h3>Inventory</h3>
        <ul
          style="list-style-type: none; height: 100%"
          id="upgradeInventory"
        ></ul>
      </inventory>
    </div>
    <script>
      
      const userID = (new URLSearchParams(window.location.search)).get("user");
      var currentPoints = 0;
      var miningValue = 0;
      var miningPassive = 0;

      function pointsUpdate() {
        const pointDisplay = document.getElementById("pointDisplay");
        pointDisplay.innerText = `Current Points: ${currentPoints}`;
      }
      pointsUpdate();
      
      function fetchUpgrades() {
        // Fetch from backend
        let upgradeArray = [
          // This will be replaced by the fetch
          { Name: "Steel Pickaxe", Effect: "ADD", Value: 5 },
          { Name: "Electric Lantern", Effect: "MULTIPLY", Value: 2 },
          { Name: "Gnome Assistants", Effect: "PASSIVE", Value: 1 },
          { Name: "Good Meal", Effect: "EXPONENT", Value: 1 },
        ];

        miningValue = 0;
        miningPassive = 0;
        var miningAddition = 0;
        var miningMultiply = 1;
        var miningExponent = 1;

        for (let i = 0; i < upgradeArray.length; i++) {
          if (upgradeArray[i].Effect === "ADD") {
            miningAddition += upgradeArray[i].Value;
          } else if (upgradeArray[i].Effect === "MULTIPLY") {
            miningMultiply += upgradeArray[i].Value;
          } else if (upgradeArray[i].Effect === "EXPONENT") {
            miningExponent += upgradeArray[i].Value;
          } else if (upgradeArray[i].Effect === "PASSIVE") {
            miningPassive += upgradeArray[i].Value;
          } else {
            alert(
              `Invalid upgrade effect: ${upgradeArray[i].Effect} from ${upgradeArray[i].Name} upgrade`
            );
          }
        }
        console.log(
          `Addition: ${miningAddition}, Exponent: ${miningExponent}, Multiplier: ${miningMultiply}, Passive: ${miningPassive}`
        );
        miningValue = miningAddition ** miningExponent * miningMultiply;
        return upgradeArray;
      }

      function calculatePoints() {
        fetchUpgrades();
        var timeSinceLastClick = 60; // Time in seconds since the last click
        currentPoints += miningValue + miningPassive * timeSinceLastClick;
        console.log(`Current points: ${currentPoints}`);
        pointsUpdate();
      }

      function buyUpgrade(name) {
        alert(`${name} was bought.`);
        updateUpgrades();
      }

      function updateUpgrades() {
        const inventoryList = document.getElementById("upgradeInventory");
        const shopList = document.getElementById("upgradeShop");
        inventoryList.innerHTML = "";
        shopList.innerHTML = "";
        let userUpgrades = fetchUpgrades();
        // Do a fetch of all possible upgrades (From upgrades table)
        let exampleUpgradeList = [
          { Name: "Steel Pickaxe", Effect: "ADD", Value: 5 },
          { Name: "Qubit Pickaxe", Effect: "ADD", Value: 25 },
          { Name: "Basic Lantern", Effect: "MULTIPLY", Value: 1.5 },
          { Name: "Electric Lantern", Effect: "MULTIPLY", Value: 2 },
          { Name: "Gnome Assistants", Effect: "PASSIVE", Value: 1 },
          { Name: "Good Meal", Effect: "EXPONENT", Value: 1 },
        ];

        for (let i = 0; i < exampleUpgradeList.length; i++) {
          found = false;
          for (let j = 0; j < userUpgrades.length; j++) {
            if (exampleUpgradeList[i].Name == userUpgrades[j].Name) {
              found = true;
              break;
            }
          }
          if (found) {
            const inventoryElement = document.createElement("li");
            inventoryElement.innerText = exampleUpgradeList[i].Name;
            inventoryList.appendChild(inventoryElement);
          } else {
            const shopElement = document.createElement("li");
            shopElement.innerText = exampleUpgradeList[i].Name;
            const elementButton = document.createElement("button");
            elementButton.innerText = "Buy";
            elementButton.addEventListener("click", () => {
              buyUpgrade(exampleUpgradeList[i].Name);
            });
            shopElement.appendChild(elementButton);
            shopList.appendChild(shopElement);
          }
        }
      }
      updateUpgrades();

      function regularFetch() {
        console.log("A fetch would have been executed right now!");
        // This function will send a POST request every few seconds to update the USERS table
      }
      setInterval(regularFetch, 5000);
    </script>
  </body>
</html>
